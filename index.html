<!DOCTYPE html>
<html class="no-js" lang="">
  <head>
    <meta charset="utf-8" />
    <title>npm - project statusboard</title>
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.datatables.net/v/dt/dt-1.10.20/b-1.6.1/b-colvis-1.6.1/b-print-1.6.1/cr-1.5.2/fh-3.1.6/datatables.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Poppins:300,400,600,700|Source+Sans+Pro&:300,400,600,700Sour&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="index.css" />
  </head>

  <body>
    <header>
      <a href="https://npmjs.com/"><span>‚ù§</span>npmjs.com</a>
    </header>
    <main>
      <h2><strong>npm</strong> project statusboard</h2>
      <small class="built"><strong>Last built: {{built}}</strong></small>
      <h6>Toggle Columns:</h6>
      <ul class="columns">
        <li><button data-column="1">Package</button></li>
        <li><button data-column="2">Stars</button></li>
        <li><button data-column="3">Issues</button></li>
        <li><button data-column="4">Issue Trendline</button></li>
        <li><button data-column="5">Pull Requests</button></li>
        <li><button data-column="6">License</button></li>
        <li><button data-column="7">Last Commit</button></li>
        <li><button data-column="8">Build Status</button></li>
        <li><button data-column="9">Node</button></li>
        <li><button data-column="10">Downloads (/m)</button></li>
        <li><button data-column="11">Coverage</button></li>
        <li><button data-column="12">Size</button></li>
        <li><button data-column="13">Version</button></li>
        <li><button data-column="14">Branch</button></li>
      </ul>
      <div id="template"></div>
      <table class="table table-striped table-bordered" data-sortable>
        <thead>
          <tr>
            <th>Name</th>
            <th>Package</th>
            <th>Stars</th>
            <th>Issues</th>
            <th>Issue Trend</th>
            <th>Pull&nbsp;Requests</th>
            <th>License</th>
            <th>Last Commit</th>
            <th>Build&nbsp;Status</th>
            <th>Node</th>
            <th>Downloads&nbsp;(/m)</th>
            <th>Coverage</th>
            <th>Size&nbsp;(KB)</th>
            <th>Version</th>
            <th>Branch</th>
          </tr>
        </thead>
      </table>
      <!-- <table class="table table-striped table-bordered" data-sortable>
            <thead>
                <tr>
                    <th>
                        Name
                    </th>
                    <th>
                        Package
                    </th>
                    <th>
                        Stars
                    </th>
                    <th>
                        Issues
                    </th>
                    <th>
                        Issue Trend
                    </th>
                    <th>
                        Pull&nbsp;Requests
                    </th>
                    <th>
                        License
                    </th>
                    <th>
                        Last Commit
                    </th>
                    <th>
                        Build&nbsp;Status
                    </th>
                    <th>
                        Node
                    </th>
                    <th>
                        Downloads&nbsp;(/m)
                    </th>
                    <th>
                        Coverage
                    </th>
                    <th>
                        Size&nbsp;(KB)
                    </th>
                    <th>
                        Version
                    </th>
                    <th>
                        Branch
                    </th>
                </tr>
            </thead>
            <tbody>
                {{#each repos}}
                <tr>
                    <td>
                        <a href="{{url}}" target="_blank">{{name}}</a>
                    </td>
                    <td>
                        <a href="https://www.npmjs.com/package/{{package}}" target="_blank">{{package}}</a>
                    </td>
                    <td>
                        <a href="{{url}}/stargazers" target="_blank">{{stargazers_count}}</a>
                    </td>
                    <td>
                        <a href="{{url}}/issues" target="_blank">{{issues_count}}</a>
                    </td>
                    <td>

                    </td>
                    <td>
                        <a href="{{url}}/pulls" target="_blank">{{prs_count}}</a>
                    </td>
                    <td class="license">
                        {{#if license}}
                        {{license.key}}
                        {{else}}
                        <span class="na">n/a</span>
                        {{/if}}
                    </td>
                    <td data-order="{{pushed_at}}">
                        {{pushed_at_diff}}
                    </td>
                    <td class="status">
                        {{#if build_status}}
                        <span class="{{build_status}}">{{build_status}}</span>
                        {{/if}}
                    </td>
                    <td data-order="{{node}}">
                        {{#if version}}
                        {{#if node}}
                        {{node}}
                        {{ else }}
                        <span class="na">n/a</span>
                        {{/if}}
                        {{/if}}
                    </td>
                    <td>
                        {{downloads}}
                    </td>
                    <td class="coverage" data-order="{{coverage}}">
                        {{#if coverage}}
                        <a href="https://coveralls.io/github/{{owner}}/{{name}}" target="_blank"><span
                                class="{{coverageLevel}}">{{coverage}}</span></a>
                        {{else}}
                        <span class="na">n/a</span>
                        {{/if}}
                    </td>
                    <td data-order="{{size}}">
                        {{size}}
                    </td>
                    <td data-order="{{version}}">
                        {{version}}
                    </td>
                    <td>
                        {{default_branch}}
                    </td>
                </tr>
                {{/each}}
            </tbody>
        </table> -->
    </main>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.7.7/handlebars.min.js"
      integrity="sha512-RNLkV3d+aLtfcpEyFG8jRbnWHxUqVZozacROI4J2F1sTaDqo1dPQYs01OMi1t1w9Y2FdbSCDSQ2ZVdAC8bzgAg=="
      crossorigin="anonymous"
    ></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jquery-sparklines/2.1.2/jquery.sparkline.min.js"
      integrity="sha512-3PRVLmoBYuBDbCEojg5qdmd9UhkPiyoczSFYjnLhFb2KAFsWWEMlAPt0olX1Nv7zGhDfhGEVkXsu51a55nlYmw=="
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/@fnando/sparkline@0.3.10/dist/sparkline.min.js"></script>
    <script
      type="text/javascript"
      src="https://cdn.datatables.net/v/dt/dt-1.10.20/b-1.6.1/b-colvis-1.6.1/b-print-1.6.1/cr-1.5.2/fh-3.1.6/datatables.min.js"
    ></script>
    <script>
      const DAY = 24 * 60 * 60 * 1000;

      const getDateRangeList = (days, start = new Date()) => {
        const range = [start];
        for (let i = 1; i < days; i++) {
          range.push(new Date(start - i * DAY));
        }
        return range;
      };

      const toDatePath = (d) =>
        `${zeroPad(d.getUTCFullYear())}/${zeroPad(
          d.getUTCMonth() + 1
        )}/${d.getUTCDate()}.json`;

      const zeroPad = (n) => (n >= 10 ? n : `0${n}`);

      let $table;

      $(document).ready(async function () {
        const response = await fetch("data/latest.json");
        let {
          data: latestData,
          created_at: latestDate,
        } = await response.json();

        latestData = latestData.reduce((accum, repo) => {
          accum[repo.id] = repo;
          return accum;
        }, {});
        latestDate = new Date(latestDate);

        const datePaths = getDateRangeList(30, latestDate).map(toDatePath);

        const repoByDates = await Promise.all(
          datePaths.map(async (path) => {
            const r = await fetch(`data/${path}`);
            return r.json();
          })
        );

        // each row in repoByDates represents the date at datePaths[i]
        repoByDates.forEach((repoByDate, dateIdx) => {
          repoByDate.forEach((repo) => {
            const { id } = repo;
            const current = latestData[id];

            if (!current) return;

            if (!current.issue_list_by_date)
              current.issue_list_by_date = new Array(30).fill(0);

            current.issue_list_by_date[dateIdx] = repo.issues_count;
          });
        });

        const repoIds = Object.keys(latestData);

        const datasource = Object.values(latestData);

        $table = $("table").DataTable({
          data: datasource,
          columns: [
            {
              data: "name",
            },
            { data: "package" },
            { data: "stargazers_count" },
            { data: "issues_count" },
            {
              data: "issue_list_by_date",
              defaultContent: "",
              render: function (data, type, row) {
                const isZeroRange = data.every((value) => value === 0);
                let someOption = 7;
                const issuesByDate = data.slice(0, someOption);
                if (issuesByDate && !isZeroRange) {
                  return `<svg id=${row.id} class="sparkline sparkline-${
                    row.name.charAt(0) === "."
                      ? row.name.split("").slice(1).join("")
                      : row.name
                  }" width="100" height="40" stroke-width="3"></svg>`;
                }
                return '<span class="na">n/a</span>';
              },
            },
            { data: "prs_count" },
            {
              data: "license.key",
              defaultContent: "",
              render: function (data, type, row) {
                if (!data) {
                  return '<span class="na">n/a</span>';
                }
                return data;
              },
            },
            { data: "pushed_at_diff" },
            { data: "build_status", defaultContent: "" },
            {
              data: "node",
              defaultContent: "",
              render: function (data, type, row) {
                if (data && row.version) {
                  return data;
                }
                return '<span class="na">n/a</span>';
              },
            },
            {
              data: "downloads",
              defaultContent: 0,
              render: function (data) {
                return Intl.NumberFormat("en-US").format(data);
              },
            },
            {
              data: "coverage",
              defaultContent: "",
              render: function (data, type, row) {
                if (data) {
                  return `<a href="https://coveralls.io/github/${row.owner}/${row.name}" target="_blank"><span class="${row.coverageLevel}">${data}</span></a>`;
                }
                return '<span class="na">n/a</span>';
              },
            },
            { data: "size" },
            { data: "version" },
            { data: "default_branch" },
          ],
          paging: false,
          colReorder: true,
          stateSave: true,
          autoWidth: false,
          language: {
            search: "Filter Projects:",
            searchPlaceholder: "Search...",
          },
          buttons: ["colvis"],
          stateLoaded: function (settings, data) {
            data.columns.forEach(
              (c, i) => !c.visible && $(`[data-column=${i}]`).addClass("hidden")
            );
          },
          fnDrawCallback: function (oSettings) {
            datasource.forEach((repo) => {
              const repoName =
                repo.name.charAt(0) === "."
                  ? repo.name.split("").slice(1).join("")
                  : repo.name;
              const el = document.querySelector(`.sparkline-${repoName}`);
              if (el) {
                sparkline.sparkline(
                  document.querySelector(`.sparkline-${repoName}`),
                  repo.issue_list_by_date,
                  { interactive: true }
                );
              }
            });
          },
        });

        $(".columns button").on("click", function (e) {
          e.preventDefault();
          $(this).toggleClass("hidden");
          var column = $table.column($(this).attr("data-column"));
          column.visible(!column.visible());
          $table.columns.adjust().draw();
        });
      });
    </script>
  </body>
</html>
